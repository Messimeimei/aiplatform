{% extends "base.html" %}
{% block title %}智能发现{% endblock %}
{% block container_class %}container py-3{% endblock %}

{% block extra_head %}
<style>
  .surface { background:#fff; color:#212529; border-radius:14px; padding:16px; box-shadow:0 8px 24px rgba(0,0,0,.08); }
  .card-flat { background:#fff; border-radius:12px; border:1px solid #e9ecef; box-shadow:0 4px 14px rgba(0,0,0,.06); }
  .input-box {
    height: 320px; overflow: auto; border: 1px solid #ced4da; border-radius: 12px;
    background: #ffffff; padding: 12px 14px; font-size: 14px; line-height: 1.6; outline: none;
  }
  .input-box[contenteditable="true"]:empty:before {
    content: attr(data-placeholder); color: #6c757d;
  }
  .upload-box { border:1px dashed #ced4da; border-radius:12px; padding:24px; text-align:center; background:#f8f9fa; }
  .upload-box input[type="file"] { display:none; }
  .upload-box .filename { margin-top:10px; color:#6c757d; font-size:.9rem; }
  .chips { display:flex; flex-wrap:wrap; gap:8px; }
  .chip { display:inline-flex; align-items:center; justify-content:center; padding:6px 12px;
          border-radius:999px; border:1px solid #cfe3ff; background:#f4f8ff; color:#0b5ed7; font-size:13px; }
  .result-body { max-height: 220px; overflow:auto; }
</style>
{% endblock %}

{% block content %}
<div class="surface">
  <div class="row g-3">
    <!-- 左侧：输入区 -->
    <div class="col-12 col-lg-8">
      <div class="card card-flat h-100">
        <div class="card-header d-flex align-items-center justify-content-between">
          <div class="btn-group" role="group" aria-label="识别类型">
            <button type="button" class="btn btn-outline-primary active" id="btnText">文本识别</button>
            <button type="button" class="btn btn-outline-primary" id="btnFile">文件识别</button>
          </div>
          <div class="small text-muted">选择识别方式，输入内容后开始识别</div>
        </div>
        <div class="card-body">
          <!-- 文本模式 -->
          <div id="modeText">
            <label class="form-label">请输入待识别文本</label>
            <div id="textInput"
                 class="input-box"
                 contenteditable="true"
                 spellcheck="false"
                 data-placeholder="在此粘贴或输入文本…"></div>
          </div>
          <!-- 文件模式 -->
          <div id="modeFile" class="d-none">
            <label class="form-label">请选择待识别文件</label>
            <div class="upload-box" id="uploadArea">
              <label class="btn btn-outline-secondary">
                选择文件
                <input type="file" id="fileInput" accept=".txt,.pdf,.doc,.docx,.md,.rtf,.csv"/>
              </label>
              <div class="filename" id="fileName">尚未选择文件</div>
            </div>
          </div>
        </div>
        <div class="card-footer bg-white d-flex gap-2 justify-content-end">
          <button class="btn btn-outline-secondary" id="btnClear">清空</button>
          <button class="btn btn-success" id="btnRun">开始识别</button>
        </div>
      </div>
    </div>

    <!-- 右侧：结果区 -->
    <div class="col-12 col-lg-4">
      <div class="card card-flat mb-3">
        <div class="card-header fw-semibold">关键技术</div>
        <div class="card-body result-body" id="techResult">
          <div class="text-muted">识别结果将显示在这里…</div>
        </div>
      </div>
      <div class="card card-flat">
        <div class="card-header fw-semibold">关键产品</div>
        <div class="card-body result-body" id="productResult">
          <div class="text-muted">识别结果将显示在这里…</div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {

  const btnText = document.getElementById('btnText');
  const btnFile = document.getElementById('btnFile');
  const modeText = document.getElementById('modeText');
  const modeFile = document.getElementById('modeFile');
  if (!btnText || !btnFile) return console.warn("❗ DOM 未加载完整");

  // —— 模式切换
  btnText.addEventListener('click', ()=>{
    btnText.classList.add('active'); btnFile.classList.remove('active');
    modeText.classList.remove('d-none'); modeFile.classList.add('d-none');
  });
  btnFile.addEventListener('click', ()=>{
    btnFile.classList.add('active'); btnText.classList.remove('active');
    modeFile.classList.remove('d-none'); modeText.classList.add('d-none');
  });

  // —— 文件名显示
  const fileInput = document.getElementById('fileInput');
  const fileNameEl = document.getElementById('fileName');
  fileInput?.addEventListener('change', ()=>{
    fileNameEl.textContent = fileInput.files?.[0]?.name || '尚未选择文件';
  });

  // —— 清空
  const btnClear = document.getElementById('btnClear');
  btnClear?.addEventListener('click', ()=>{
    document.getElementById('textInput').innerText = '';
    const f = document.getElementById('fileInput');
    if (f) { f.value = ''; document.getElementById('fileName').textContent = '尚未选择文件'; }
    clearResults();
  });

  // —— 开始识别
  const btnRun = document.getElementById('btnRun');
  btnRun?.addEventListener('click', async ()=>{
    clearResults();
    const isTextMode = btnText.classList.contains('active');
    btnRun.disabled = true;
    btnRun.innerText = '识别中...';

    try {
      let data = {};
      if (isTextMode) {
        const text = document.getElementById('textInput').innerText.trim();
        if (!text) { toast('请输入文本后再识别'); resetBtn(); return; }
        const res = await fetch('/api/identify', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ mode: 'text', text })
        });
        data = await res.json();
      } else {
        const file = document.getElementById('fileInput').files?.[0];
        if (!file) { toast('请选择文件后再识别'); resetBtn(); return; }
        const fd = new FormData(); fd.append('mode','file'); fd.append('file',file);
        const res = await fetch('/api/identify', { method: 'POST', body: fd });
        data = await res.json();
      }
      if (data.error) throw new Error(data.error);
      renderResults(data);
    } catch (err) {
      toast('识别失败：' + err.message);
    } finally {
      resetBtn();
    }

    function resetBtn(){
      btnRun.disabled = false;
      btnRun.innerText = '开始识别';
    }
  });

  // —— 工具函数
  function clearResults(){
    document.getElementById('techResult').innerHTML = '<div class="text-muted">识别结果将显示在这里…</div>';
    document.getElementById('productResult').innerHTML = '<div class="text-muted">识别结果将显示在这里…</div>';
  }
  function renderResults(data){
    const tech = document.getElementById('techResult');
    const prod = document.getElementById('productResult');
    tech.innerHTML = chipTemplate(data.tech || []);
    prod.innerHTML = chipTemplate(data.product || []);
  }
  function chipTemplate(arr){
    if (!arr.length) return '<div class="text-muted">（无识别结果）</div>';
    return '<div class="chips">'+
      arr.map(t=>`<span class="chip">${escapeHtml(t)}<span class="mark">识别</span></span>`).join('')+
    '</div>';
  }
  function toast(msg){ alert(msg); }
  function escapeHtml(s){ return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
});
</script>
{% endblock %}
