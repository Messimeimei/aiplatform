{% extends "base.html" %}
{% block title %}全画像{% endblock %}
{% block container_class %}container py-3{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
<style>
  /* ===== 全局底色：统一淡紫 ===== */
  html, body { height: 100%; }
  body { background:#f6f0ff !important; color:#212529; }

  /* 让容器与行透明，避免双底色叠加 */
  .container, .surface, .row, #viewport { background: transparent !important; }

  /* ===== 标题条（可复用）===== */
  .bar-title{ position:relative; padding-left:.75rem; font-weight:600; }
  .bar-title::before{
    content:""; position:absolute; left:0; top:.15em; bottom:.15em;
    width:3px; border-radius:2px; background:#6f42c1;
  }

  /* ===== 卡片：紫系边与柔和阴影 ===== */
  .card-flat{
    background:#fff; border:1px solid #ece9ff; border-radius:14px;
    box-shadow:0 8px 22px rgba(111,66,193,.10);
  }
  .card-flat .card-header{
    background:linear-gradient(180deg,#faf8ff,#f5f2ff);
    border-bottom:1px solid #ece9ff;
    padding:8px 12px; font-size:.95rem;
  }
  .card-body{ padding:12px 14px; }

  /* ===== 左列：检索与介绍 ===== */
  #leftCol{ display:flex; flex-direction:column; gap:10px; }

  /* 表单更紧凑 */
  #searchForm .form-label{ font-size:.8rem; color:#6b7280; margin-bottom:.25rem; }
  #searchForm .form-select, #searchForm .form-control{ border-color:#e0dcff; }
  #searchForm .form-select:focus, #searchForm .form-control:focus{
    box-shadow:0 0 0 .2rem rgba(111,66,193,.15); border-color:#c8bfff;
  }
  #searchForm .btn-success{
    background:#5c7cfa; border-color:#5c7cfa;
  }
  #searchForm .btn-success:hover{ background:#4c6ef5; border-color:#4c6ef5; }

  /* 节点介绍区：高度可滚动，内容排版更好看 */
  .intro-box{
    max-height:240px; overflow:auto;
    border:1px solid #ece9ff; border-radius:12px; padding:10px;
    background:#fbfaff;
  }
  .intro-box h5{ font-size:1.05rem; }
  .intro-box .meta{ color:#6b7280; font-size:.85rem; }
  .intro-box .pill{
    display:inline-block; padding:.2rem .5rem; border-radius:999px;
    background:#f2edff; color:#4c1d95; border:1px solid #e4dcff; font-size:.8rem;
  }
  .intro-box hr{ border-color:#ece9ff; opacity:1; }

  .card-footer{
    border-top:1px solid #ece9ff;
  }
  .btn-outline-secondary.btn-sm{ border-color:#e0dcff; color:#4b5563; }
  .btn-outline-secondary.btn-sm:hover{ background:#f2edff; border-color:#c8bfff; color:#382f6b; }
  .btn-primary.btn-sm{ background:#6f42c1; border-color:#6f42c1; }
  .btn-primary.btn-sm:hover{ background:#5b35a6; border-color:#5b35a6; }

  /* ===== 右列：图谱卡片“填满” ===== */
  #rightCol{ display:flex; flex-direction:column; }
  #rightCol .card{ flex:1; display:flex; flex-direction:column; margin-bottom:0; }
  #rightCol .card-body{
    flex:1; display:flex; flex-direction:column; padding:10px 12px;
  }

  #graphWrap{
    flex:1; min-height:240px;
    border:1px solid #ece9ff; border-radius:12px; background:#f8fafc; overflow:hidden;
  }
  #graphCanvas{ width:100%; height:100%; display:block; }

  /* ===== 表单提示 & 小字色 ===== */
  .text-muted{ color:#6b7280 !important; }

  /* ===== 自定义滚动条（WebKit）===== */
  .intro-box::-webkit-scrollbar{ width:10px; }
  .intro-box::-webkit-scrollbar-thumb{
    background:#dcd6ff; border-radius:10px; border:2px solid #fbfaff;
  }
  .intro-box::-webkit-scrollbar-track{ background:#fbfaff; border-radius:10px; }

  /* 页脚留白 */
  footer{ margin-top:12px; }
</style>
{% endblock %}

{% block content %}
<div class="surface">
  <div class="d-flex align-items-center justify-content-between mb-2">
    <h2 class="bar-title m-0">全画像</h2>
    <div class="small text-muted">可拖拽 / 缩放；点击节点查看详情</div>
  </div>

  <div id="viewport" class="row g-3">
    <!-- 左侧 -->
    <div class="col-12 col-lg-4" id="leftCol">
      <div class="card card-flat">
        <div class="card-header fw-semibold">检索与生成</div>
        <div class="card-body">
          <form id="searchForm" class="row g-2 align-items-stretch">
            <div class="col-12">
              <label class="form-label small mb-1">领域</label>
              <select id="domainSelect" class="form-select">
                <option value="brain">脑机接口（brain）</option>
                <option value="chip">芯片（chip）</option>
                <option value="dialogue">对话（dialogue）</option>
                <option value="dl">深度学习（dl）</option>
                <option value="robot">机器人（robot）</option>
                <option value="video">视频生成（video）</option>
              </select>
            </div>
            <div class="col-9">
              <label class="form-label small mb-1">搜索节点（名称/ID）</label>
              <input id="searchInput" class="form-control" placeholder="例如：高密度脑电 或 tech_bci003" autocomplete="off">
            </div>
            <div class="col-3 d-grid align-content-end">
              <button class="btn btn-success" type="submit" style="height:38px;">生成</button>
            </div>
          </form>
          <div class="small text-muted mt-2">提示：先选择领域，再输入关键词；支持完整 ID。</div>
        </div>
      </div>

      <div class="card card-flat">
        <div class="card-header fw-semibold">节点介绍</div>
        <div class="card-body">
          <div class="intro-box" id="introBox">
            <div class="text-muted">
              这里显示当前领域的节点简介。你可以：
              <ul class="mb-0">
                <li>在上方搜索；</li>
                <li>点击右侧图谱中的节点。</li>
              </ul>
            </div>
          </div>
        </div>
        <div class="card-footer bg-white d-flex gap-2 justify-content-end">
          <button class="btn btn-outline-secondary btn-sm" id="btnClear">清空</button>
          <button class="btn btn-primary btn-sm" id="btnFocus">聚焦当前节点</button>
        </div>
      </div>
    </div>

    <!-- 右侧 -->
    <div class="col-12 col-lg-8" id="rightCol">
      <div class="card card-flat h-100">
        <div class="card-header fw-semibold d-flex justify-content-between align-items-center">
          <span>节点图谱</span>
          <span class="small text-muted">ECharts Graph</span>
        </div>
        <div class="card-body">
          <div id="graphWrap">
            <div id="graphCanvas"></div>
          </div>
        </div>
      </div>
    </div>
  </div><!-- /row -->
</div>
{% endblock %}

{% block scripts %}
<script>
let chart = null;
let graphData = { nodes: [], edges: [] };
let activeId = null;
let ro = null; // ResizeObserver

function initChart() {
  chart = echarts.init(document.getElementById('graphCanvas'));

  chart.on('click', async (p) => {
    if (p.dataType === 'node') {
      await selectNode(p.data.id);
    }
  });

  // 强制自适应，避免底部空白
  window.addEventListener('resize', () => chart && chart.resize());
  const wrap = document.getElementById('graphWrap');
  ro = new ResizeObserver(() => { if (chart) chart.resize(); });
  ro.observe(wrap);
}

async function loadDomainGraph(domain) {
  const res = await fetch(`/api/portrait_graph?domain=${encodeURIComponent(domain)}`);
  graphData = await res.json() || {nodes:[], edges:[]};
  renderGraph();

  // 双保险 resize，杜绝“没填满”现象
  requestAnimationFrame(() => chart.resize());
  setTimeout(() => chart.resize(), 0);

  if (graphData.nodes.length) {
    await selectNode(graphData.nodes[0].id);
  } else {
    document.getElementById('introBox').innerHTML = '<div class="text-muted">该领域暂无图数据。</div>';
  }
}

function renderGraph() {
  const colorOf = k => k==='tech' ? '#5b6fd7' : (k==='product' ? '#2f855a' : '#6b7280');
  const sizeOf  = k => k==='tech' ? 36 : (k==='product' ? 32 : 28);

  chart.setOption({
    tooltip: {
      trigger: 'item',
      backgroundColor: '#fff',
      borderColor: '#ece9ff',
      textStyle: { color:'#111' },
      formatter: p => p.dataType==='node'
        ? `<b>${escapeHTML(p.data._raw.name)}</b><br><span class="text-muted">ID：</span>${escapeHTML(p.data._raw.id)}`
        : ''
    },
    animation: false,
    series: [{
      type: 'graph',
      layout: 'force',
      roam: true,
      force: { repulsion: 220, edgeLength: [90, 150] },
      label: { show: true, fontSize: 12, color: '#1f2937' },
      lineStyle: { color: '#b9c1d0', width: 1.4, curveness: 0.15 },
      edgeLabel: { show:false },
      data: graphData.nodes.map(n => ({
        id: n.id,
        name: n.name,
        symbolSize: sizeOf(n.kind),
        itemStyle: { color: colorOf(n.kind), borderColor:'#fff', borderWidth:1.5 },
        _raw: n
      })),
      links: graphData.edges.map(e => ({ source: e.source, target: e.target, _raw: e }))
    }]
  });
}

async function selectNode(id) {
  activeId = id;
  const domain = document.getElementById('domainSelect').value;
  const res = await fetch(`/api/portrait_node_detail?domain=${encodeURIComponent(domain)}&node_id=${encodeURIComponent(id)}`);
  const d = await res.json();
  renderIntro(d);

  // 聚焦提示：显示 tip 并轻微高亮
  const data = chart.getOption().series[0].data || [];
  const idx = data.findIndex(x=>x.id===id);
  if (idx>=0){
    chart.dispatchAction({ type:'showTip', seriesIndex:0, dataIndex:idx });
    chart.dispatchAction({ type:'highlight', seriesIndex:0, dataIndex:idx });
    setTimeout(()=>chart.dispatchAction({ type:'downplay', seriesIndex:0, dataIndex:idx }), 600);
  }
}

function renderIntro(d) {
  const box = document.getElementById('introBox');
  if (!d || !d.id) { box.innerHTML = '<div class="text-muted">暂无详情</div>'; return; }

  const src = (d.source||[]).map((s,i)=>`
    <li class="mb-1">
      <span class="pill me-1">来源 ${i+1}</span>
      <a href="${s}" target="_blank" rel="noopener">${escapeHTML(s)}</a>
    </li>`).join('');

  box.innerHTML = `
    <h5 class="mb-1">${escapeHTML(d.name||'-')}</h5>
    <div class="meta mb-2">ID：${escapeHTML(d.id||'-')}</div>
    <p class="mb-2">${escapeHTML(d.abstract||'无简介')}</p>
    ${src?`<hr class="my-2"><ul class="mb-0 ps-3">${src}</ul>`:''}
  `;
}

function escapeHTML(s){ return (s??'').toString().replace(/[&<>"']/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

/* 交互 */
document.addEventListener('DOMContentLoaded', () => {
  initChart();
  loadDomainGraph('brain');

  document.getElementById('domainSelect').addEventListener('change', e => {
    loadDomainGraph(e.target.value);
  });

  document.getElementById('searchForm').addEventListener('submit', async (ev) => {
    ev.preventDefault();
    const q = (document.getElementById('searchInput').value || '').trim().toLowerCase();
    if (!q) return;

    const hit = graphData.nodes.find(n =>
      (n.id || '').toLowerCase() === q ||
      (n.name || '').toLowerCase().includes(q)
    );
    if (hit) {
      await selectNode(hit.id);
    } else {
      alert('该领域未找到此节点');
    }
  });

  document.getElementById('btnClear').addEventListener('click', () => {
    document.getElementById('introBox').innerHTML =
      '<div class="text-muted">已清空。请选择右侧节点或重新搜索。</div>';
  });

  document.getElementById('btnFocus').addEventListener('click', () => {
    if (!activeId) return;
    const data = chart.getOption().series[0].data || [];
    const idx = data.findIndex(x=>x.id===activeId);
    if (idx>=0) chart.dispatchAction({ type:'showTip', seriesIndex:0, dataIndex:idx });
  });
});
</script>
{% endblock %}
