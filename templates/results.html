{% extends "base.html" %}
{% block title %}检索结果{% endblock %}
{% block container_class %}container py-3{% endblock %}

{% block extra_head %}
<style>
  :root{
    --violet-50:#f6f0ff;
    --violet-100:#efe7ff;
    --violet-200:#e6dcff;
    --violet-500:#6f42c1;
    --ink-800:#1f2937;
    --ink-600:#4b5563;
    --ink-500:#6b7280;
  }
  body{ background: var(--violet-50) !important; }

  .results-surface{
    background:#fff; color:#212529; border-radius:16px; padding:16px;
    box-shadow:0 10px 28px rgba(111,66,193,.08); border:1px solid var(--violet-200);
  }
  .subhead{
    display:flex; align-items:center; gap:.75rem; padding:.6rem .8rem; border:1px solid #ece9ff;
    border-radius:12px; background:linear-gradient(180deg,#faf8ff,#f6f2ff);
  }
  .subhead .pill{
    background:#efe9ff; color:#5a34a5; border:1px solid #e1d9ff; border-radius:999px; padding:.18rem .55rem; font-size:.8rem;
  }
  .subhead .q{ color:var(--ink-800); font-weight:600; }
  .subhead .muted{ color:var(--ink-500); }

  .hover-card{
    transition: transform .15s ease, box-shadow .15s ease; cursor:pointer; position:relative;
    border:1px solid rgba(0,0,0,.06); border-radius:12px; background:#fff;
    box-shadow:0 4px 14px rgba(111,66,193,.06);
  }
  .hover-card:hover{ transform:translateY(-2px); box-shadow:0 12px 28px rgba(111,66,193,.12); }

  .card-title{ font-weight:700; color:#111827; }
  .badge.kind{ background:#edf2ff; color:#2b4db8; border:1px solid #dbe4ff; }

  .meta-block{ margin:.25rem 0 .5rem; }
  .meta-line{ display:flex; align-items:center; flex-wrap:wrap; gap:.5rem; margin-top:.25rem; }
  .meta-label{
    font-size:.75rem; color:#6c757d; background:#f1f3f5; border-radius:999px; padding:.2rem .5rem;
  }
  .chip{
    font-size:.75rem; line-height:1.6; padding:.2rem .55rem; border-radius:999px;
    background:#eef3ff; color:#2149b5; border:1px solid #d8e2ff;
  }

  .line-clamp-2{
    display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden; color:#374151;
  }

  /* 分页样式 */
  .pagination {
    --bs-pagination-hover-bg:#f4f0ff;
    --bs-pagination-active-bg:#6f42c1;
    --bs-pagination-active-border-color:#6f42c1;
  }
  .page-link{ border-radius:8px; }
  .page-item + .page-item .page-link{ margin-left:.25rem; }

  /* 空状态 */
  .empty{
    padding:24px; text-align:center; color:var(--ink-600);
    border:1px dashed #dedbf7; background:#fbfaff; border-radius:12px;
  }
</style>
{% endblock %}

{% block content %}
{# ---------- 前端分页参数（每页 4 条） ---------- #}
{% set page_size = 4 %}
{% set page = (request.args.get('page', 1) | int) %}
{% set total = items|length %}
{% set total_pages = (total + page_size - 1) // page_size %}
{% set start = (page - 1) * page_size %}
{% set end = start + page_size %}
{% set page_items = items[start:end] %}

<div class="results-surface">
  <h1 class="h4 mb-3 text-dark">检索结果</h1>

  <div class="subhead mb-3">
    <span class="pill">
      {{ (type_ or request.args.get('type','tech')) == 'product' and '关键产品' or '关键技术' }}
    </span>
    <div class="q">关键词：{{ q or request.args.get('q','') }}</div>
    <div class="muted ms-auto">共 {{ total }} 条</div>
    <a href="{{ url_for('base.index') }}" class="btn btn-sm btn-outline-secondary">返回修改</a>
  </div>

  {% if page_items %}
    <div class="row row-cols-1 row-cols-md-2 g-3">
      {% for item in page_items %}
      <div class="col">
        <div class="card hover-card h-100">
          <div class="card-body">
            <div class="d-flex align-items-start justify-content-between">
              <h5 class="card-title mb-1 me-2">{{ item.name }}</h5>
              <span class="badge kind">{{ item.kind }}</span>
            </div>

            {% if item.org and item.org != '-' %}
            <div class="meta-block small text-muted">
              {{ item.org|safe }}
            </div>
            {% endif %}

            {% if item.abstract %}
              <p class="card-text line-clamp-2 mb-0">{{ item.abstract }}</p>
            {% endif %}

            <a href="{{ url_for('base.detail_page', item_id=item.id) }}" class="stretched-link" aria-label="查看详情：{{ item.name }}"></a>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="empty">未检索到结果，请更换关键词或切换类型。</div>
  {% endif %}

  {# ---------- 滑动窗口分页（会随当前页移动） ---------- #}
  {% if total_pages > 1 %}
    {% set max_show = 5 %}
    {% set half = (max_show - 1) // 2 %}

    {# 初步窗口 #}
    {% set start_page = [1, page - half] | max %}
    {% set end_page = [total_pages, start_page + max_show - 1] | min %}
    {# 如果贴到末尾，向前补齐窗口宽度 #}
    {% set start_page = [1, end_page - max_show + 1] | max %}

    <nav class="mt-3" aria-label="分页">
      <ul class="pagination pagination-sm mb-0">

        {# 上一页 #}
        <li class="page-item {{ page <= 1 and 'disabled' or '' }}">
          <a class="page-link" href="?q={{ q }}&type={{ type_ }}&page={{ page > 1 and (page - 1) or 1 }}">上一页</a>
        </li>

        {# 如窗口不含第一页，则显示 1 与省略号 #}
        {% if start_page > 1 %}
          <li class="page-item {{ page == 1 and 'active' or '' }}">
            <a class="page-link" href="?q={{ q }}&type={{ type_ }}&page=1">1</a>
          </li>
          {% if start_page > 2 %}
            <li class="page-item disabled"><span class="page-link">…</span></li>
          {% endif %}
        {% endif %}

        {# 窗口内页码 #}
        {% for p in range(start_page, end_page + 1) %}
          <li class="page-item {{ p == page and 'active' or '' }}">
            <a class="page-link" href="?q={{ q }}&type={{ type_ }}&page={{ p }}">{{ p }}</a>
          </li>
        {% endfor %}

        {# 如窗口不含最后一页，则显示省略号与最后一页 #}
        {% if end_page < total_pages %}
          {% if end_page < total_pages - 1 %}
            <li class="page-item disabled"><span class="page-link">…</span></li>
          {% endif %}
          <li class="page-item {{ page == total_pages and 'active' or '' }}">
            <a class="page-link" href="?q={{ q }}&type={{ type_ }}&page={{ total_pages }}">{{ total_pages }}</a>
          </li>
        {% endif %}

        {# 下一页 #}
        <li class="page-item {{ page >= total_pages and 'disabled' or '' }}">
          <a class="page-link" href="?q={{ q }}&type={{ type_ }}&page={{ page < total_pages and (page + 1) or total_pages }}">下一页</a>
        </li>

      </ul>
    </nav>
  {% endif %}
</div>
{% endblock %}
